<!-- ... existing code ... -->
<!-- REGISTRATION MULTI-STEP -->
<div id="registerCard" class="card hidden" style="margin-top:12px">
  <h3 style="margin:0;color:var(--white)">Register New User</h3>
  <div class="muted">Follow steps: Personal → Bank → Category & Terms → Finish</div>

  <div id="regSteps" style="margin-top:14px">
    <!-- Step 2: Personal -->
    <div id="regStep2">
      <strong>Personal Details</strong>
      <form id="regForm">
        <input type="hidden" id="reg_level">
        <div class="row">
          <!-- ... existing fields ... -->
        </div>
        <!-- ... other rows ... -->
        <div style="margin-top:12px;display:flex;justify-content:space-between">
          <div><button type="button" class="btn ghost" id="backToSelect" onclick="showScreen('selectOrg')">Back</button></div>
          <div><button type="button" class="btn" id="toBank">Continue to Bank →</button></div>
        </div>
      </form>
    </div>

    <!-- Step 3: Bank & credentials -->
    <div id="regStep3" class="hidden" style="margin-top:12px">
      <strong>Bank & Credentials</strong>
      <div class="row">
        <!-- ... existing bank fields ... -->
      </div>
      <div class="row" style="margin-top:10px">
        <!-- ... username/password ... -->
      </div>
      <div style="margin-top:12px;display:flex;justify-content:space-between">
        <button class="btn ghost" id="backToPersonal">Back</button>
        <button class="btn" id="toCategory">Continue to Category →</button>
      </div>
    </div>

    <!-- Step 4: Category & Terms -->
    <div id="regStep4" class="hidden" style="margin-top:12px">
      <strong>Category & Terms</strong>
      <div class="row">
        <div class="col"><label>Selected Level</label><input id="showLevel" readonly></div>
        <div class="col"><label>Main category *</label>
          <select id="mainCategory" class="gold-input-select">
            <option value="">Select</option>
            <option value="central">Central</option>
            <option value="state">State</option>
            <option value="divisional">Divisional</option>
            <option value="zone">Zone</option>
            <option value="cluster">Cluster</option>
            <option value="miniCluster">Mini Cluster</option>
            <option value="groupLeader">Group Leader</option>
            <option value="worker">Worker</option>
            <option value="sabhasad">Sabhasad</option>
          </select>
        </div>
        <div class="col"><label>Subcategory *</label>
          <select id="subCategory" class="gold-input-select">
            <option value="">Choose main first</option>
          </select>
        </div>
      </div>
      <!-- NEW SUBCATEGORY INPUT -->
      <div class="row">
        <div class="col">
          <label>Add Subcategory</label>
          <input type="text" id="addSubcategoryInput" placeholder="Enter new subcategory">
          <button type="button" class="btn" id="addSubcategoryBtn">Add Subcategory</button>
        </div>
      </div>
      <!-- ... terms & buttons ... -->
      <div id="termsWrap" class="small hidden" style="margin-top:12px;background:rgba(255,255,255,0.02);padding:10px;border-radius:8px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Terms & Reference</strong></div>
          <div><a id="termsLink" href="#" target="_blank" style="color:var(--accent)">Open link</a></div>
        </div>
        <div style="margin-top:8px"><label style="color:var(--muted)"><input id="agreeTC" type="checkbox"> I have read & agree</label></div>
      </div>
      <div style="margin-top:12px;display:flex;justify-content:space-between">
        <button class="btn ghost" id="backToBank">Back</button>
        <button class="btn" id="submitReg">Agree & Register</button>
      </div>
    </div>
  </div>
</div>
<!-- ... rest of page ... -->

<script>
/* ... existing JS ... */

// ---- SUBCATEGORY ADDITION ----

// Helper to get orgData from localStorage
function getOrgData() {
  try { return JSON.parse(localStorage.getItem('orgData')) || {}; } catch(e){ return {}; }
}

// Populate subcategories based on main category selection
function populateSubs(){
  const main = document.getElementById('mainCategory').value;
  const level = document.getElementById('reg_level').value || 'gaarrkh';
  const subSel = document.getElementById('subCategory');
  subSel.innerHTML = '<option value="">Select sub</option>';
  const orgData = getOrgData();
  if(orgData && orgData[level] && orgData[level][main] && Array.isArray(orgData[level][main].subs)){
    orgData[level][main].subs.forEach(s=>{
      const o = document.createElement('option'); o.value = s; o.textContent = s; subSel.appendChild(o);
    });
    // show link if exists
    const obj = orgData[level][main];
    if(obj && (obj.mainLink || obj.subLinks)){ document.getElementById('termsLink').href = obj.mainLink || '#'; document.getElementById('termsWrap').classList.remove('hidden'); return; }
  }
  // fallback: hide terms
  document.getElementById('termsWrap').classList.add('hidden');
}
document.getElementById('mainCategory').addEventListener('change', populateSubs);
document.getElementById('subCategory').addEventListener('change', ()=>{
  const level = document.getElementById('reg_level').value || 'gaarrkh';
  const sub = document.getElementById('subCategory').value;
  const orgData = getOrgData();
  if(orgData && orgData[level] && orgData[level][document.getElementById('mainCategory').value]){
    const obj = orgData[level][document.getElementById('mainCategory').value];
    if(obj && obj.subLinks && obj.subLinks[sub]){
      document.getElementById('termsLink').href = obj.subLinks[sub]; document.getElementById('termsWrap').classList.remove('hidden'); return;
    }
  }
});

// ADD SUBCATEGORY BUTTON LOGIC
document.getElementById('addSubcategoryBtn').addEventListener('click', function() {
  const newSub = document.getElementById('addSubcategoryInput').value.trim();
  const main = document.getElementById('mainCategory').value;
  const level = document.getElementById('reg_level').value || 'gaarrkh';
  if(!main) { alert('Select a main category first.'); return; }
  if(!newSub) { alert('Enter a subcategory name.'); return; }
  // Get orgData or create structure
  let orgData = getOrgData();
  if(!orgData[level]) orgData[level] = {};
  if(!orgData[level][main]) orgData[level][main] = {subs:[]};
  if(!Array.isArray(orgData[level][main].subs)) orgData[level][main].subs = [];
  if(orgData[level][main].subs.includes(newSub)) {
    alert('Subcategory already exists.');
    return;
  }
  orgData[level][main].subs.push(newSub);
  localStorage.setItem('orgData', JSON.stringify(orgData));
  populateSubs();
  document.getElementById('addSubcategoryInput').value = '';
  alert('Subcategory added!');
});

</script>
<!-- ... rest of page ... -->
